"use strict";var _slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var s,a=t[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&a.return&&a.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t},_createClass=function(){function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(t,e){"object"===("undefined"==typeof module?"undefined":_typeof(module))&&"object"===_typeof(module.exports)?module.exports=e(t,require("fabric").fabric):e(t,t.fabric,!0)}("undefined"!=typeof window?window:void 0,function(e,t,n){var m=t.Canvas,o=t.Circle,l=t.Path;t.Object.prototype.originX=t.Object.prototype.originY="center";var i=function(){function t(){_classCallCheck(this,t),this._events={}}return _createClass(t,[{key:"on",value:function(t,e){if("function"!=typeof e)throw new Error("method (on) only takes instances of Function");return this._events[t]?this._events[t]=[this._events[t],e]:this._events[t]=e,this}},{key:"off",value:function(t,e){if(!this._events[t])return this;e||delete this._events[t];var n=this._events[t];if(Array.isArray(n)){var i=n.indexOf(e);if(i<0)return this;n.splice(i,1),(n.length=0)&&delete this._events[t]}else n===e&&delete this._events[t];return this}},{key:"emit",value:function(t){for(var e=this,n=arguments.length,i=Array(1<n?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];var r=this._events[t];return!!r&&("function"==typeof r?(r.call.apply(r,[this].concat(i)),!0):!!Array.isArray(r)&&(r.forEach(function(t){t.call.apply(t,[e].concat(i))}),!0))}},{key:"removeAllListeners",value:function(){return this._events={},this}}]),t}(),r=function(t){function g(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=e.strokeWidth,i=void 0===n?1:n,o=e.lineStroke,r=void 0===o?"#000":o,s=e.arrowRadius,a=void 0===s?6:s,h=e.editable,l=void 0!==h&&h,u=e.formatter,c=void 0===u?function(){return""}:u,d=e.hasShadow,f=void 0!==d&&d,v=e.pathOpacity,p=void 0===v?1:v,y=arguments[2];_classCallCheck(this,g);var b=_possibleConstructorReturn(this,(g.__proto__||Object.getPrototypeOf(g)).call(this));return b.config={strokeWidth:i,lineStroke:r,arrowRadius:a,editable:l,formatter:c,hasShadow:f,pathOpacity:p},b.canvas=new m(t,{selection:!1}),b.lineMap={},b.currentLineId=null,b.pathShadow={color:"#fff",blur:5,offsetX:.5,offsetY:.5},b.newEmptyLine(),b.initListeners(),y&&b.load(y),!l&&b.insertTooltip(),b}return _inherits(g,i),_createClass(g,[{key:"dispose",value:function(){this.canvas.dispose(),this.config.editable&&e.removeEventListener("keydown",this.onKeydown)}},{key:"insertTooltip",value:function(){this.tooltip=document.createElement("div"),this.tooltip.className="tooltip",this.canvas.wrapperEl.appendChild(this.tooltip)}},{key:"resize",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=t.width,n=t.height;void 0!==e&&void 0!==n&&(this.canvas.setDimensions({width:e,height:n}),this.reload())}},{key:"convert",value:function(t){var e=this.canvas,n=e.width,i=e.height;return t.map(function(t){return[t[0]*n,t[1]*i]})}},{key:"load",value:function(t){var o=this;t&&t.length&&("string"==typeof t&&(t=JSON.parse(t)),this.dataSource=t,this.lineMap={},t.forEach(function(i){o.newEmptyLine(),o.convert(i.dots).forEach(function(t){var e=o.getCurrentLine(),n=o.makeDot.apply(o,_toConsumableArray(t));e.dots.push(n),o.renderLines(i)})}))}},{key:"setConfig",value:function(t){this.config=_extends({},this.config,t),this.reload()}},{key:"reload",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.dataSource;this.canvas.clear(),this.load(t)}},{key:"newEmptyLine",value:function(){var t=Object.values(this.lineMap).find(function(t){return 0===t.dots.length});if(t)this.currentLineId=t.id;else{var e=Array.from({length:8},function(){return Math.floor(65536*(1+Math.random())).toString(16).substr(1)}).join("");this.lineMap[e]={dots:[],id:e,path:null},this.currentLineId=e}}},{key:"getLinesInfo",value:function(){var e=this;return Object.values(this.lineMap).map(function(t){return t.path?{strokeWidth:t.path.strokeWidth,stroke:t.path.stroke,dots:t.dots.map(function(t){return[t.left/e.canvas.width,t.top/e.canvas.height]})}:{}})}},{key:"getCurrentLine",value:function(){return this.lineMap[this.currentLineId]}},{key:"configCurrentPath",value:function(t){var e=this.getCurrentLine().path;e&&(e.set(t),this.renderLines())}},{key:"initListeners",value:function(){this.onObjectMoving=this.onObjectMoving.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseOver=this.onMouseOver.bind(this),this.onMouseOut=this.onMouseOut.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onKeydown=this.onKeydown.bind(this);var t=this.config.editable?{"object:moving":this.onObjectMoving,"mouse:down":this.onMouseDown}:{"mouse:over":this.onMouseOver,"mouse:out":this.onMouseOut,"mouse:move":this.onMouseMove};this.canvas.on(t),this.config.editable&&e.addEventListener("keydown",this.onKeydown)}},{key:"showToolTip",value:function(){this.tooltip.style.visibility="visible"}},{key:"hideToolTip",value:function(){this.tooltip.style.visibility="hidden"}},{key:"isToolTipHidden",value:function(){return"hidden"===this.tooltip.style.visibility}},{key:"onKeydown",value:function(t){"Delete"===t.code?this.delCurrentLine():"KeyZ"===t.code&&t.ctrlKey&&this.delSelectedDot()}},{key:"onMouseMove",value:function(t){this.config.editable||this.isToolTipHidden()||(this.tooltip.style.left=t.pointer.x+"px",this.tooltip.style.top=t.pointer.y+"px")}},{key:"onMouseOver",value:function(t){if(!this.config.editable){var e=t.target;e&&"path"===e.name&&(this.showToolTip(),this.tooltip.innerHTML=this.config.formatter(e._data))}}},{key:"onMouseOut",value:function(t){if(!this.config.editable){var e=t.target;e&&"path"===e.name&&this.hideToolTip()}}},{key:"onObjectMoving",value:function(t){this.config.editable&&"dot"===t.target.name&&this.renderLines()}},{key:"onMouseDown",value:function(t){if(this.config.editable){t.e.ctrlKey&&this.newEmptyLine();var e=t.target;if(!e){var n=this.getCurrentLine(),i=this.makeDot(t.pointer.x,t.pointer.y);n.dots.push(i),this.renderLines(),this.selectDot(i),this.selectCurrentPath()}e&&"dot"===e.name&&(this.currentLineId=e.parentLine.id,this.selectDot(e),this.selectCurrentPath())}}},{key:"selectDot",value:function(t){this.lastSelectedDot&&this.lastSelectedDot.set({fill:"transparent",stroke:"#ddd",radius:5,selected:!1}),(this.lastSelectedDot=t).set({fill:"#fff0f0",stroke:"#0000ff",radius:8,selected:!0}),this.emit("focus.dot",t)}},{key:"selectCurrentPath",value:function(){var t=this.getCurrentLine().path;this.lastSelectedPath&&this.lastSelectedPath.set({shadow:null,selected:!1}),(this.lastSelectedPath=t).set({shadow:this.pathShadow,selected:!0}),this.emit("focus.path",t)}},{key:"delSelectedDot",value:function(){if(this.config.editable){var t=this.getCurrentLine();if(this.lastSelectedDot){var e=t.dots.indexOf(this.lastSelectedDot),n=t.dots.splice(e,1),i=_slicedToArray(n,1)[0];this.canvas.remove(i),this.renderLines(),this.emit("del.dot",i)}}}},{key:"delCurrentLine",value:function(){var e=this;if(this.config.editable){var t=this.getCurrentLine();if(t.path.selected){t.dots.forEach(function(t){return e.canvas.remove(t)}),this.canvas.remove(t.path),delete this.lineMap[t.id];var n=Object.keys(this.lineMap);n.length?this.currentLineId=n[0]:this.newEmptyLine()}}}},{key:"renderLines",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(0!==t.strokeWidth){var e=t.stroke||this.config.lineStroke,n=t.strokeWidth||this.config.strokeWidth,i=this.config.editable,o={stroke:e,strokeWidth:n,opacity:this.config.pathOpacity,hoverCursor:i?"move":"pointer",fill:"",originX:"left",originY:"top",selectable:!1,evented:!i},r=this.getCurrentLine();!i&&this.config.hasShadow&&(o.shadow=this.pathShadow);var s=r.dots.map(function(t){return[t.left,t.top]}),a=this.makeSvgCurvePath.apply(this,_toConsumableArray(s));r.path&&(Object.assign(o,{stroke:r.path.stroke,shadow:r.path.shadow,strokeWidth:r.path.strokeWidth}),this.canvas.remove(r.path));var h=new l(a,o);h.name="path",h._data=t,r.path&&(this.lastSelectedPath=h),r.path=h,this.canvas.add(h)}}},{key:"makeDot",value:function(t,e){var n=this.getCurrentLine(),i=new o({left:t,top:e,strokeWidth:3,radius:5,fill:"transparent",stroke:this.config.editable?"#ddd":"transparent",evented:this.config.editable,shadow:{color:"#000",blur:2,offsetX:1,offsetY:1}});return i.hasControls=i.hasBorders=!1,i.name="dot",i.parentLine=n,this.canvas.add(i),i}},{key:"getCanvasInfo",value:function(){return this.canvas.toJSON()}},{key:"makeSvgCurvePath",value:function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=e.length;if(i<2)return"";var o=e[i-1],r=e[i-2],s=Math.PI/6,a=this.config.arrowRadius,h=r[1]-o[1],l=o[0]-r[0],u=Math.atan(h/l),c=l<0?-1:1,d=o[0]-Math.cos(u+s)*a*c,f=o[1]+Math.sin(u+s)*a*c,v=o[0]-Math.cos(u-s)*a*c,p=o[1]+Math.sin(u-s)*a*c,y=[["M",d,f],["L"].concat(_toConsumableArray(o)),["L",v,p],["L",d,f],["L"].concat(_toConsumableArray(o))];if(2===i)return[["M"].concat(_toConsumableArray(e[0])),["L"].concat(_toConsumableArray(e[1]))].concat(y);for(var b=[["M"].concat(_toConsumableArray(e[0]))],g=1;g<i-1;g++){var m=(e[g][0]+e[g+1][0])/2,k=(e[g][1]+e[g+1][1])/2;b.push(["Q"].concat(_toConsumableArray(e[g]),[m,k]))}return b.push.apply(b,[["T"].concat(_toConsumableArray(o))].concat(y)),b}}]),g}();return n&&(e.LineDrawer=r),r});